<div class="page">
  <header class="topbar">
    <div class="brand">
      <h1>Hawai&#x02BB;i State of the Climate</h1>
    </div>
  </header>

  <div class="grid">
    <!-- LEFT COLUMN: Map + Trend stacked to match sidebar height -->
    <div class="left-col">
      <!-- Map Panel -->
      <section class="panel panel-grow">
        <div class="panel-head">
          <div>
            <div class="eyebrow">Map</div>
            <div class="title">Click an island to explore</div>
          </div>
          <button *ngIf="selectedIsland()" class="btn" (click)="reset()">Reset</button>
        </div>
        <div class="map">
          <div class="selection-overlay">
            <div class="eyebrow">Selection</div>
            <div class="crumbs">
              <span class="chip" (click)="reset()">Statewide</span>
              <ng-container *ngIf="selectedIsland() as si">
                <span class="sep">›</span>
                <button class="chip chip-active" (click)="selectedDivision.set(null)">
                  {{ si.short }}
                </button>
                <ng-container *ngIf="selectedDivision() as sd">
                  <span class="sep">›</span>
                  <span class="chip chip-county">{{ sd }}</span>
                </ng-container>
              </ng-container>
            </div>

            <div class="scope-wrap">
              <label for="scope" class="label tiny">Scope</label>
              <div class="tiny muted mt-1" *ngIf="!selectedIsland()">
                Select an island first to view by scope.
              </div>
              <select id="scope"
                      class="input"
                      [ngModel]="selectedScope()"
                      (ngModelChange)="setScope($event)">
                <option value="divisions">Climate Divisions</option>
                <option value="moku">Moku</option>
                <option value="ahupuaa">Ahupuaʻa</option>
                <option value="watershed">Watersheds</option>
              </select>
              <div class="scope-wrap" *ngIf="viewMode() === 'divisions'">
                <label for="divisionSelect" class="label tiny">
                  {{ selectedScope() | titlecase }}
                </label>
                <select id="divisionSelect"
                        class="input mt-1"
                        [ngModel]="selectedDivision()"
                        (ngModelChange)="pickDivision($event)">
                  <option *ngFor="let f of islands(); trackBy: trackByIsle" 
                          [value]="f.name">
                    {{ f.name }}
                  </option>
                </select>
              </div>

              
            </div>
          </div>
          <svg viewBox="0 0 560 320" class="map-svg" role="img" aria-label="Hawaiʻi islands (abstract)">
            <defs>
              <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
                <feGaussianBlur stdDeviation="3" result="blur" />
                <feMerge>
                  <feMergeNode in="blur" />
                  <feMergeNode in="SourceGraphic" />
                </feMerge>
              </filter>
              <pattern id="grid" width="24" height="24" patternUnits="userSpaceOnUse">
                <path d="M 24 0 L 0 0 0 24" fill="none" stroke="rgba(0,0,0,0.05)" stroke-width="1" />
              </pattern>
            </defs>
            <rect x="0" y="0" width="560" height="320" fill="url(#grid)" />

            <!-- Draw all island/division polygons first -->
            <g class="features">
              <path
                *ngFor="let feature of islands(); trackBy: trackByIsle"
                [attr.d]="pathById()[feature.id]"
                [attr.fill]="
                  viewMode() === 'divisions' && selectedDivision() === feature.name
                    ? 'var(--primary)'
                    : hoveredFeature() === feature.name
                      ? '#cbd5e1'
                      : '#e5e7eb'
                "
                [attr.stroke]="
                  viewMode() === 'divisions' && selectedDivision() === feature.name
                    ? 'var(--ring)'
                    : hoveredFeature() === feature.name
                      ? '#6b7280'
                      : '#9ca3af'
                "
                [attr.stroke-width]="
                  viewMode() === 'divisions' && selectedDivision() === feature.name
                    ? 2
                    : hoveredFeature() === feature.name
                      ? 2
                      : 1
                "
                [attr.filter]="
                  viewMode() === 'divisions' && selectedDivision() === feature.name
                    ? 'url(#glow)'
                    : null
                "
                (mouseover)="onHover(feature, $event)"
                (mouseout)="hoveredLabel.set(null)"
                (click)="viewMode() === 'islands' ? pickIsland(feature) : pickDivision(feature.name)"
              ></path>
            </g>

            <!-- Draw all labels on top -->
            <g class="labels">
              <g *ngIf="viewMode() === 'divisions' && selectedScope() === 'ahupuaa' && hoveredLabel() as hl">
                <text
                  [attr.x]="hl.x"
                  [attr.y]="hl.y - 6"
                  text-anchor="middle"
                  class="ahupuaa-label"
                >
                  {{ hl.name }}
                </text>
              </g>


              <ng-container *ngFor="let feature of islands(); trackBy: trackByIsle">
                <ng-container *ngIf="centroidById()[feature.id] as c">
                    <text
                      *ngIf="!(viewMode() === 'divisions' && selectedScope() === 'ahupuaa')" 
                      [attr.x]="c[0]"
                      [attr.y]="c[1] + 12"
                      text-anchor="middle"
                      class="island-label"
                    >
                      {{ feature.short }}
                    </text>

                </ng-container>
              </ng-container>
            </g>




          </svg>
        </div>
      </section>

      <!-- Trend Panel -->
      <section class="panel panel-grow">
        <div class="panel-head">
          <div>
            <div class="eyebrow">Trend</div>
            <div class="title">SPI-{{ selectedTimescale() }} — last 12 months</div>
          </div>
          <div class="tiny">{{ selectedDivision() || selectedIsland()?.short || 'Statewide' }}</div>
        </div>
        <div class="chart-wrap">
          <app-spi-chart [data]="tsData()" [unit]="unit()"></app-spi-chart>

        </div>
      </section>
    </div>

    <!-- RIGHT SIDEBAR -->
    <aside class="aside">
      <div class="panel">

        <div class="mt">
          <div class="subhead">Choose a dataset</div>
          <div class="chips">
            <button class="chip chip-option" [class.chip-selected]="selectedDataset() === 'Rainfall'" (click)="pickDataset('Rainfall')">Rainfall</button>
            <button class="chip chip-option" [class.chip-selected]="selectedDataset() === 'Temperature'" (click)="pickDataset('Temperature')">Temperature</button>
          </div>
        </div>

        <div class="mt">
          <div class="subhead">Choose a time range</div>
          <div class="chips">
            <button class="chip chip-option" 
                    [class.chip-selected]="selectedTimescale() === 1" 
                    (click)="setTimescale(1)">Short Term</button>
            <button class="chip chip-option" 
                    [class.chip-selected]="selectedTimescale() === 6" 
                    (click)="setTimescale(6)">Medium Term</button>
            <button class="chip chip-option" 
                    [class.chip-selected]="selectedTimescale() === 12" 
                    (click)="setTimescale(12)">Long Term</button>
          </div>
        </div>


        <div class="actions">
          <button class="btn" (click)="reset()">Clear</button>
        </div>
      </div>

      <div class="panel">
        <div class="panel-head">
          <div>
            <div class="eyebrow">Climate snapshot</div>
            <div class="title">
              {{ selectedDataset() }} – {{ selectedDivision() || selectedIsland()?.short || 'Statewide' }} • {{ timeRangeLabel(selectedTimescale()) }}
            </div>
            


          </div>
        </div>
        <div class="info-box">
          Statewide saw exceptionally dry conditions in August (short term).
        </div>
        <!-- Only show selected dataset; each stat in its own box -->
        <div *ngIf="selectedDataset() === 'Rainfall'; else tempStats" class="stats">
          <app-stat-box label="RF" value="1.97 in"></app-stat-box>
          <app-stat-box label="Anomaly" value="-3.20 in"></app-stat-box>
          <app-stat-box label="Rank" value="Driest"></app-stat-box>
        </div>
        <ng-template #tempStats>
          <div class="stats">
            <app-stat-box label="Temp" value="70.0 °F"></app-stat-box>
            <app-stat-box label="Anomaly" value="0.6 °F"></app-stat-box>
            <app-stat-box label="Rank" value="9th Warmest"></app-stat-box>
          </div>
        </ng-template>

        <!-- Timescale slider 1..12 with bubble -->
        <!-- <div class="mt">
          <div class="eyebrow">Time scale</div>
          <div class="slider-wrap">
            <input type="range" min="1" max="12" step="1" [ngModel]="selectedTimescale()" (ngModelChange)="setTimescale($event)"/>
            <div class="bubble" [ngStyle]="{ left: ((selectedTimescale() - 1) / 11 * 100) + '%' }">{{ selectedTimescale() }} mo</div>
            <div class="slider-ends"><span>1 mo</span><span>12 mo</span></div>
          </div>
        </div> -->
      </div>

      <div class="panel">
        <div class="eyebrow">Monthly email reports</div>
        <div class="muted">Get a monthly report for your current selection.</div>

        <div class="mt">
          <div class="summary">
            <div class="muted">Selection</div>
            <div class="strong">{{ selectedDataset() }} — {{ selectedDivision() || selectedIsland()?.short || 'Statewide' }} • {{ selectedTimescale() }}-month</div>
          </div>
        </div>

        <label class="label" for="email">Email address</label>
        <input
          id="email"
          class="input"
          type="email"
          [ngModel]="email()"
          (ngModelChange)="email.set($event)"
          placeholder="you@example.com"
        />

        <div class="tiny error" *ngIf="email() && !isEmailValid()">
          Please enter a valid email.
        </div>

        <div class="actions">
          <button class="btn btn-primary" [disabled]="!isEmailValid()" (click)="subscribe()">
            Subscribe
          </button>
          <button class="btn" (click)="email.set('')">Clear</button>
        </div>
        <div class="tiny muted">We’ll send a report around the 1st of each month. You can unsubscribe anytime.</div>
      </div>
    </aside>
  </div>
</div>