<div class="page">
  <header class="topbar">
    <div class="brand">
      <h1>Hawai&#x02BB;i State of the Climate</h1>
    </div>
  </header>

  <div class="grid">
    <!-- LEFT COLUMN: Map + Trend stacked to match sidebar height -->
    <div class="left-col">
      <!-- Map Panel -->
      <!-- Climate Snapshot — hero at the top-left -->
      <section class="panel snapshot-hero">
        <div class="panel-head">
          <div>
            <div class="eyebrow">Climate snapshot</div>
            <div class="title">
              {{ selectedDataset() }} – {{ selectedDivision() || selectedIsland()?.short || 'Statewide' }} • {{ timeRangeLabel(selectedTimescale()) }}
            </div>
          </div>

          <!-- Controls bar -->
          <div class="snapshot-controls">
            <!-- Dataset -->
            <div class="control" role="group" aria-labelledby="datasetLabel">
              <div class="tiny muted" id="datasetLabel">Select a dataset</div>
              <div class="chips chips-toggle" role="tablist" aria-label="Dataset">
                <button class="chip chip-option"
                        [class.chip-selected]="selectedDataset() === 'Rainfall'"
                        (click)="pickDataset('Rainfall')">Rainfall</button>
                <button class="chip chip-option"
                        [class.chip-selected]="selectedDataset() === 'Temperature'"
                        (click)="pickDataset('Temperature')">Temperature</button>
                <button class="chip chip-option"
                        [class.chip-selected]="selectedDataset() === 'Drought'"
                        (click)="pickDataset('Drought')">Drought</button>
              </div>
            </div>

            <!-- Time scale -->
            <div class="control" role="group" aria-labelledby="timescaleLabel">
              <div class="tiny muted" id="timescaleLabel">Select a time scale</div>
              <div class="chips">
                <button class="chip chip-option"
                        [class.chip-selected]="selectedTimescale() === 1"
                        (click)="setTimescale(1)">Last month</button>
                <button class="chip chip-option"
                        [class.chip-selected]="selectedTimescale() === 6"
                        (click)="setTimescale(6)">Last 6 months</button>
                <button class="chip chip-option"
                        [class.chip-selected]="selectedTimescale() === 12"
                        (click)="setTimescale(12)">Last 12 months</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Statement -->
        <div class="info-box">
          Statewide saw exceptionally dry conditions in August (short term).
        </div>

        <!-- Tiles -->
        <div *ngIf="selectedDataset() === 'Rainfall'; else tempOrSpi" class="stats stats-rainfall">
          <app-stat-box label="RF" value="2.0 in"></app-stat-box>
          <app-stat-box label="Anomaly" value="-3.2 in"></app-stat-box>
        </div>

        <ng-template #tempOrSpi>
          <div class="stats">
            <ng-container *ngIf="selectedDataset() === 'Temperature'; else emptyRow">
              <app-stat-box label="Temp" value="70.0 °F"></app-stat-box>
              <app-stat-box label="Anomaly" value="+0.6 °F"></app-stat-box>
            </ng-container>
            <ng-template #emptyRow></ng-template>
          </div>
        </ng-template>

        <!-- Shared row: Rank | SPI -->
        <div class="stats">
          <app-stat-box label="Rank" value="Driest" note="out of 35 years"></app-stat-box>
          <app-stat-box label="SPI" value="Exceptionally Dry"></app-stat-box>
        </div>
      </section>

      <section class="panel panel-grow">
        <div class="panel-head">
          <div>
            <div class="eyebrow">Map</div>
            <div class="title">Click an island to explore</div>
          </div>
          <button *ngIf="selectedIsland()" class="btn" (click)="reset()">Reset</button>
        </div>
        <div class="map">
          <div class="selection-overlay">
            <div class="eyebrow">Selection</div>
            <div class="crumbs">
              <span class="chip" (click)="reset()">Statewide</span>
              <ng-container *ngIf="selectedIsland() as si">
                <span class="sep">›</span>
                <button class="chip chip-active" (click)="selectedDivision.set(null)">
                  {{ countyLabel() || si.short }}
                </button>
                <ng-container *ngIf="selectedDivision() as sd">
                  <span class="sep">›</span>
                  <span class="chip chip-county">{{ selectedDivisionName() }}</span>
                </ng-container>
              </ng-container>
            </div>
            <!-- County quick-picks (always visible) -->
            <div class="mt-1">
              <div class="label tiny">Select County:</div>
              <div class="chips">
                <button
                  class="chip chip-option"
                  [class.chip-selected]="selectedCounty() === 'Kauaʻi'"
                  (click)="pickCounty('Kauaʻi')"
                >Kauaʻi</button>

                <button
                  class="chip chip-option"
                  [class.chip-selected]="selectedCounty() === 'Honolulu'"
                  (click)="pickCounty('Honolulu')"
                >Honolulu</button>

                <button
                  class="chip chip-option"
                  [class.chip-selected]="selectedCounty() === 'Maui'"
                  (click)="pickCounty('Maui')"
                >Maui</button>

                <button
                  class="chip chip-option"
                  [class.chip-selected]="selectedCounty() === 'Hawaiʻi'"
                  (click)="pickCounty('Hawaiʻi')"
                >Hawaiʻi</button>
              </div>
            </div>

            <div class="scope-wrap">
              <label for="scope" class="label tiny">Select division:</label>
              <!-- Scope chips -->
              <div class="chips mt-1" role="tablist" aria-label="Scope">
                <button
                  class="chip chip-option"
                  [class.chip-selected]="selectedScope() === 'divisions'"
                  (click)="setScope('divisions')"
                  role="tab"
                  [attr.aria-selected]="selectedScope() === 'divisions' ? 'true' : 'false'"
                >
                  Climate Divisions
                </button>

                <button
                  class="chip chip-option"
                  [class.chip-selected]="selectedScope() === 'moku'"
                  (click)="setScope('moku')"
                  role="tab"
                  [attr.aria-selected]="selectedScope() === 'moku' ? 'true' : 'false'"
                >
                  Moku
                </button>

                <button
                  class="chip chip-option"
                  [class.chip-selected]="selectedScope() === 'ahupuaa'"
                  (click)="setScope('ahupuaa')"
                  role="tab"
                  [attr.aria-selected]="selectedScope() === 'ahupuaa' ? 'true' : 'false'"
                >
                  Ahupuaʻa
                </button>
              </div>
                <div class="scope-wrap" *ngIf="viewMode() === 'divisions' && selectedScope()">
                <label for="divisionSelect" class="label tiny">
                  {{ selectedScope() | titlecase }}
                </label>
                <select id="divisionSelect"
                        class="input mt-1"
                        [ngModel]="selectedDivision()"
                        (ngModelChange)="pickDivision($event)">
                  <option *ngFor="let f of islands(); trackBy: trackByIsle" [value]="f.key">
                    {{ f.name }}
                  </option>

                </select>
              </div>

              
            </div>
          </div>
          <svg viewBox="0 0 560 320" class="map-svg" role="img" aria-label="Hawaiʻi islands (abstract)">
            <defs>
              <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
                <feGaussianBlur stdDeviation="3" result="blur" />
                <feMerge>
                  <feMergeNode in="blur" />
                  <feMergeNode in="SourceGraphic" />
                </feMerge>
              </filter>
              <pattern id="grid" width="24" height="24" patternUnits="userSpaceOnUse">
                <path d="M 24 0 L 0 0 0 24" fill="none" stroke="rgba(0,0,0,0.05)" stroke-width="1" />
              </pattern>
            </defs>
            <rect x="0" y="0" width="560" height="320" fill="url(#grid)" />
            <image
              *ngIf="rasterHref() && rasterRect() && selectedDataset() === 'Rainfall'"
              [attr.href]="rasterHref()"
              [attr.x]="rasterRect()!.x"
              [attr.y]="rasterRect()!.y"
              [attr.width]="rasterRect()!.width"
              [attr.height]="rasterRect()!.height"
              preserveAspectRatio="none"
              style="pointer-events:none"
              opacity="0.9"
            />

            <!-- Draw all island/division polygons first -->
            <g class="features">
              <path
                *ngFor="let feature of islands(); trackBy: trackByIsle"
                [attr.d]="pathById()[feature.id]"

                [attr.fill]="
                  selectedDataset() === 'Rainfall'
                    ? (hoveredFeature() === feature.name ? '#ffffff' : 'transparent')
                    : (viewMode() === 'divisions' && selectedDivision() === feature.key
                        ? 'var(--primary)'
                        : (hoveredFeature() === feature.name ? '#cbd5e1' : '#e5e7eb'))
                "
                [attr.fill-opacity]="
                  selectedDataset() === 'Rainfall'
                    ? (hoveredFeature() === feature.name ? 0.35 : 0.001)   
                    : 1
                "

                [attr.pointer-events]="'all'"

                [attr.stroke]="
                  (viewMode() === 'divisions' && selectedDivision() === feature.key)
                    ? 'var(--ring)'
                    : (hoveredFeature() === feature.name ? '#6b7280' : '#9ca3af')
                "
                [attr.stroke-width]="
                  ((viewMode() === 'divisions' && selectedDivision() === feature.key) ||
                   hoveredFeature() === feature.name) ? 2 : 1
                "

                (click)="viewMode() === 'islands' ? pickIsland(feature) : pickDivision(feature.key)"
                (mouseenter)="hoveredFeature.set(feature.name)"
                (mouseleave)="hoveredFeature.set(null)"
                (mousemove)="onHover(feature, $event)"
              ></path>
            </g>


            <!-- Draw all labels on top -->
            <g class="labels">
              <g *ngIf="viewMode() === 'divisions' && selectedScope() === 'ahupuaa' && hoveredLabel() as hl">
                <text
                  [attr.x]="hl.x"
                  [attr.y]="hl.y - 6"
                  text-anchor="middle"
                  class="ahupuaa-label"
                >
                  {{ hl.name }}
                </text>
              </g>


              <ng-container *ngFor="let feature of islands(); trackBy: trackByIsle">
                <ng-container *ngIf="centroidById()[feature.id] as c">
                    <text
                      *ngIf="!(viewMode() === 'divisions' && selectedScope() === 'ahupuaa')" 
                      [attr.x]="c[0]"
                      [attr.y]="c[1] + 12"
                      text-anchor="middle"
                      class="island-label"
                    >
                      {{ feature.short }}
                    </text>

                </ng-container>
              </ng-container>
            </g>




          </svg>
        </div>
      </section>

    </div>

    <!-- RIGHT SIDEBAR -->
    <aside class="aside">
      <section class="panel panel-grow" [class.fullscreen]="chartFullscreen()">
        <div class="panel-head">
          <div>
            <div class="title">
              {{ selectedDataset() }} graph
            </div>

          </div>
          <div class="actions">
            <button class="btn" (click)="toggleChartFullscreen()">
              {{ chartFullscreen() ? 'Close' : 'Expand' }}
            </button>
          </div>
        </div>

        <div class="chart-wrap">
          <app-spi-chart [data]="tsData()" [unit]="unit()"></app-spi-chart>
        </div>
      </section>



      <div class="panel">
        <div class="eyebrow">Monthly email reports</div>
        <div class="muted">Get a monthly report for your current selection.</div>

        <div class="mt">
          <div class="summary">
            <div class="muted">Selection</div>
            <div class="strong">{{ selectedDataset() }} — {{ selectedDivision() || selectedIsland()?.short || 'Statewide' }} • {{ selectedTimescale() }}-month</div>
          </div>
        </div>

        <label class="label" for="email">Email address</label>
        <input
          id="email"
          class="input"
          type="email"
          [ngModel]="email()"
          (ngModelChange)="email.set($event)"
          placeholder="you@example.com"
        />

        <div class="tiny error" *ngIf="email() && !isEmailValid()">
          Please enter a valid email.
        </div>

        <div class="actions">
          <button class="btn btn-primary" [disabled]="!isEmailValid()" (click)="subscribe()">
            Subscribe
          </button>
          <button class="btn" (click)="email.set('')">Clear</button>
        </div>
        <div class="tiny muted">We’ll send a report around the 1st of each month. You can unsubscribe anytime.</div>
      </div>
    </aside>
  </div>
</div>